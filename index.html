<!-- Previous HTML content remains the same until the chat section -->

  <!-- CHAT -->
  <button class="chat-launcher" id="chatOpen" aria-label="Chat öffnen" aria-expanded="false">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
      <path d="M21 12c0 4.418-4.03 8-9 8-1.08 0-2.12-.16-3.08-.46L3 20l1.53-3.33C4.2 15.7 4 14.86 4 14c0-4.418 4.03-8 9-8s8 3.582 8 8z" stroke="#fff" stroke-width="1.6" fill="none"/>
      <circle cx="9" cy="12" r="1" fill="#fff"/><circle cx="12" cy="12" r="1" fill="#fff"/><circle cx="15" cy="12" r="1" fill="#fff"/>
    </svg>
  </button>
  <div class="chat-backdrop" id="chatBackdrop" aria-hidden="true"></div>
  <div class="chat-panel" id="chatPanel" role="dialog" aria-modal="true" aria-label="Chat">
    <div class="chat-header">
      <div class="title">Chat — MiD</div>
      <button id="chatClose" aria-label="Schließen" style="background:none;border:none;color:#9CA3AF;font-weight:700;font-size:16px;cursor:pointer">×</button>
    </div>
    <div class="chat-body" id="chatBody" aria-live="polite">
      <div class="msg bot"><div class="bubble" data-i18n="chat_welcome"></div></div>
    </div>
    <div class="chat-input">
      <input id="chatInput" type="text" data-i18n-placeholder="chat_placeholder" />
      <button id="chatSend">➤</button>
    </div>
  </div>

  <!-- Internationalization Script -->
  <script>
    // Year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // I18N dictionary
    const translations = {
      de: {
        // ... (previous translations remain unchanged)
        chat_welcome: "👋 Hallo! Beschreiben Sie kurz Ihr Ziel (Web / Google Ads / SMM / SEO) — ich gebe Ihnen einen kurzen Aktionsplan.",
        chat_placeholder: "Schreiben..."
      },
      en: {
        // ... (previous translations remain unchanged)
        chat_welcome: "👋 Hi! Tell me your goal (Web / Google Ads / SMM / SEO) — I’ll give a short action plan.",
        chat_placeholder: "Type..."
      },
      uk: {
        // ... (previous translations remain unchanged)
        chat_welcome: "👋 Привіт! Опишіть мету (Web / Google Ads / SMM / SEO) — дам короткий план дій.",
        chat_placeholder: "Напишіть..."
      },
      ru: {
        // ... (previous translations remain unchanged)
        chat_welcome: "👋 Привет! Опишите цель (Web / Google Ads / SMM / SEO) — дам короткий план действий.",
        chat_placeholder: "Напишите..."
      }
    };

    const langSelect = document.getElementById('lang');

    function applyLang(L = 'de') {
      const dict = translations[L] || translations.de;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        if (el.tagName.toLowerCase() === 'meta') {
          el.setAttribute('content', dict[key] ?? el.getAttribute('content'));
        } else {
          if (dict[key] != null) el.textContent = dict[key];
        }
      });
      // Handle placeholder attributes for inputs
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (dict[key] != null) el.placeholder = dict[key];
      });
      document.documentElement.lang = L;
      localStorage.setItem('lang', L);
      // Update <title>
      const titleKey = 'meta_title';
      if (dict[titleKey]) document.title = dict[titleKey];
    }

    const saved = localStorage.getItem('lang') || 'de';
    if (langSelect) langSelect.value = saved;
    applyLang(saved);
    langSelect?.addEventListener('change', (e) => applyLang(e.target.value));
  </script>

  <!-- Chat Functionality Script -->
  <script>
    // ====== CHAT CONFIG ======
    const API_ENDPOINT = "https://vermarkter-github-io-git-main-aaas-projects-d83c1bad.vercel.app/api/chat";

    // Get current language from select
    function currentLang() {
      return document.getElementById('lang')?.value.toLowerCase() || 'de';
    }

    // ====== CHAT DOM ======
    const chatOpen = document.getElementById('chatOpen');
    const chatClose = document.getElementById('chatClose');
    const chatPanel = document.getElementById('chatPanel');
    const chatBackdrop = document.getElementById('chatBackdrop');
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');

    // Chat history
    let history = [];

    function appendMsg(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function getReply(messages) {
      try {
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, lang: currentLang() })
        });
        const data = await res.json();
        return data.reply || "Помилка відповіді від сервера.";
      } catch (e) {
        return "Немає з’єднання з сервером.";
      }
    }

    async function send() {
      const text = chatInput.value.trim();
      if (!text) return;
      appendMsg('user', text);
      history.push({ role: 'user', content: text });
      chatInput.value = '';

      // "Typing" bubble
      const typing = document.createElement('div');
      typing.className = 'msg bot';
      typing.id = 'typing';
      const tb = document.createElement('div');
      tb.className = 'bubble';
      tb.textContent = '…';
      typing.appendChild(tb);
      chatBody.appendChild(typing);
      chatBody.scrollTop = chatBody.scrollHeight;

      const reply = await getReply(history);
      typing.remove();
      appendMsg('assistant', reply);
      history.push({ role: 'assistant', content: reply });
    }

    function openChat() {
      chatPanel.classList.add('open');
      chatBackdrop.classList.add('open');
      chatOpen?.setAttribute('aria-expanded', 'true');
      setTimeout(() => chatInput?.focus(), 30);
    }

    function closeChat() {
      chatPanel.classList.remove('open');
      chatBackdrop.classList.remove('open');
      chatOpen?.setAttribute('aria-expanded', 'false');
    }

    chatOpen?.addEventListener('click', openChat);
    chatClose?.addEventListener('click', closeChat);
    chatBackdrop?.addEventListener('click', closeChat);
    chatSend?.addEventListener('click', send);
    chatInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        send();
      }
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && chatPanel.classList.contains('open')) closeChat();
    });
  </script>
</body>
</html>
